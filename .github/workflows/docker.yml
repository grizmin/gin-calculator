name: Docker Image CI/CD

on:
  # Automatic builds on push/PR
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  
  # Manual workflow trigger for Docker Hub deployment
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (without registry)'
        required: true
        default: 'gin-calculator'
        type: string
      tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
        type: string
      push_to_dockerhub:
        description: 'Push to Docker Hub'
        required: true
        default: true
        type: boolean
      dockerhub_username:
        description: 'Docker Hub username'
        required: false
        default: ''
        type: string

env:
  # Default image name (can be overridden)
  DEFAULT_IMAGE_NAME: gin-calculator
  REGISTRY: docker.io

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Set image name and tag
      id: image-info
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          TAG="${{ github.event.inputs.tag }}"
        else
          IMAGE_NAME="${{ env.DEFAULT_IMAGE_NAME }}"
          TAG="build-$(date +%s)"
        fi
        echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "full_tag=${IMAGE_NAME}:${TAG}" >> $GITHUB_OUTPUT
    
    - name: Build Docker image
      run: |
        docker build . \
          --file Dockerfile \
          --tag ${{ steps.image-info.outputs.full_tag }} \
          --tag ${{ steps.image-info.outputs.image_name }}:latest
    
    - name: Test Docker image
      run: |
        # Run basic tests on the built image
        docker run --rm -d --name test-container -p 8080:8000 ${{ steps.image-info.outputs.full_tag }}
        sleep 10
        
        # Test if the application responds
        curl -f http://localhost:8080/ || exit 1
        
        # Cleanup
        docker stop test-container
    
    - name: Login to Docker Hub
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.event.inputs.dockerhub_username || secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Get Docker Hub username
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true'
      id: dockerhub-info
      run: |
        USERNAME="${{ github.event.inputs.dockerhub_username }}"
        if [ -z "$USERNAME" ]; then
          USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        fi
        echo "username=${USERNAME}" >> $GITHUB_OUTPUT
    
    - name: Tag for Docker Hub
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true'
      run: |
        docker tag ${{ steps.image-info.outputs.full_tag }} ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.full_tag }}
        docker tag ${{ steps.image-info.outputs.image_name }}:latest ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.image_name }}:latest
    
    - name: Push to Docker Hub
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true'
      run: |
        docker push ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.full_tag }}
        docker push ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.image_name }}:latest
    
    - name: Output image information
      run: |
        echo "🍸 Build completed successfully!"
        echo "📦 Image: ${{ steps.image-info.outputs.full_tag }}"
        echo "🏷️ Also tagged as: ${{ steps.image-info.outputs.image_name }}:latest"
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.push_to_dockerhub }}" == "true" ]; then
          echo "🚀 Pushed to Docker Hub:"
          echo "   - ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.full_tag }}"
          echo "   - ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.image_name }}:latest"
          echo ""
          echo "🐳 Pull with: docker pull ${{ steps.dockerhub-info.outputs.username }}/${{ steps.image-info.outputs.image_name }}:latest"
        else
          echo "ℹ️ Image built locally only (not pushed to registry)"
        fi
